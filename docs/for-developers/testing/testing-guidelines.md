# テストガイドライン

## Test-Driven Development (TDD) - t_wada方式

このプロジェクトでは、t_wada方式のTDDを採用しています。

### TDDサイクル

1. **最初にテストを書く（Red）**
   - 実装前に失敗するテストを書く
   - テストは具体的で、1つの振る舞いだけをテストする
   - テストの意図が明確になるような名前をつける

2. **最小限の実装（Green）**
   - テストを通すために必要最小限のコードを書く
   - この時点では汚いコードでも構わない
   - ベタ書きやハードコードも許容される
   - とにかくテストを通すことを優先する

3. **リファクタリング（Refactor）**
   - テストが通った状態を保ちながらコードを改善する
   - **必ずベタ書きやハードコードを適切な実装に置き換える**
   - 重複を取り除き、設計を改善する
   - マジックナンバーは定数化し、ハードコードされた値は設定可能にする
   - テストも必要に応じてリファクタリングする

### MVP開発時のテスト戦略

#### フェーズ1: ランディングページ検証（0-2週間）
- **A/Bテスト実装**
  - メッセージの訴求力テスト
  - 価格表示のバリエーションテスト
  - CTAボタンの文言・配置テスト

- **計測対象メトリクス**
  - ページビュー → 登録完了率
  - 滞在時間とスクロール深度
  - アンケート回答率と内容分析

#### フェーズ2: MVP実装（2-4週間）
- **コア機能のユニットテスト**
  - ビジネスロジックの正確性
  - エッジケースの処理
  - エラーハンドリング

- **決済フローのE2Eテスト**
  - Stripe連携の正常系
  - エラー時のリトライ処理
  - サブスクリプション管理

### テストの実行（開発開始後）

```bash
# ファイル変更を監視しながらテストを実行
npm run test:watch

# 特定のテストファイルのみ実行
npm test -- path/to/test.js

# カバレッジレポート付きで実行
npm run test:coverage

# E2Eテスト実行
npm run test:e2e
```

### テストの書き方の原則

- **Arrange-Act-Assert (AAA) パターンを使用**
  ```javascript
  test('日本語プロンプトから英語プロンプトが生成される', async () => {
    // Arrange - テストデータの準備
    const japanesePrompt = '桜並木を歩く女性';
    const expectedEnglishPrompt = 'A woman walking along cherry blossom trees';
    
    // Act - プロンプト変換の実行
    const result = await convertPrompt(japanesePrompt);
    
    // Assert - 結果の検証
    expect(result.english).toContain('woman');
    expect(result.english).toContain('cherry blossom');
    expect(result.quality).toBeGreaterThan(0.8);
  });
  ```

- **各テストは独立して実行可能**
  - beforeEach/afterEachを活用してクリーンな状態を保つ
  - グローバル状態に依存しない

- **モックは最小限に留める**
  - 外部API（OpenAI、Stripe等）のみモック化
  - ビジネスロジックはモックしない

- **テストデータは実際のユースケースに基づく**
  - 実際のユーザーペルソナから導出したデータを使用
  - 思い込み破壊シナリオをテストケースに反映

### SaaSプロダクト固有のテストシナリオ

#### ユーザー登録・認証
- メールアドレス検証
- パスワードポリシーの適用
- OAuth連携（Google、GitHub等）
- セッション管理とタイムアウト

#### サブスクリプション管理
- 無料トライアル開始
- 有料プランへの移行
- プランアップグレード/ダウングレード
- 解約処理とデータ保持

#### 使用量制限とクォータ
- API呼び出し回数の制限
- ストレージ使用量の計測
- 同時実行数の制御
- レート制限の実装

#### データプライバシー
- 個人情報の暗号化
- GDPRコンプライアンス
- データエクスポート機能
- アカウント削除時のデータ消去

### パフォーマンステスト

```javascript
test('プロンプト変換が3秒以内に完了する', async () => {
  const startTime = Date.now();
  
  const result = await convertPrompt('複雑な日本語の説明文...');
  
  const duration = Date.now() - startTime;
  expect(duration).toBeLessThan(3000);
});
```

### 継続的なユーザーフィードバックテスト

- **NPS（Net Promoter Score）測定**
  - 週次でのユーザー満足度調査
  - 機能改善の効果測定

- **ユーザビリティテスト**
  - 新機能のベータテスト
  - UIの直感性検証
  - タスク完了率の測定

### テスト環境の管理

```bash
# 開発環境
NODE_ENV=development

# テスト環境（モックAPI使用）
NODE_ENV=test

# ステージング環境（本番相当）
NODE_ENV=staging

# 本番環境
NODE_ENV=production
```

### CI/CDパイプラインでのテスト

1. **プルリクエスト時**
   - ユニットテスト全実行
   - コードカバレッジチェック（80%以上）
   - Lintチェック

2. **マージ時**
   - E2Eテスト実行
   - パフォーマンステスト
   - セキュリティスキャン

3. **デプロイ前**
   - スモークテスト
   - ヘルスチェック
   - ロールバック準備

### 重要な指標の監視

- **技術指標**
  - レスポンスタイム（p50, p95, p99）
  - エラー率
  - API成功率

- **ビジネス指標**
  - 登録コンバージョン率
  - 有料転換率
  - チャーン率
  - LTV/CAC比率