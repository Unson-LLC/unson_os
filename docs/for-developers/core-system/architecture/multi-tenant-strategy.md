# Unson OS マルチテナント戦略

## 結論

* **最初の Vercel + Convex 期は "フル" マルチテナントは要りません。**
  ただし、**将来の移行が楽になる "テナンシーフック" は最初から入れておく**のが絶対おすすめ。
* **Cloudflare へ移行して共通基盤を固める段階**で、必要なサービスだけ **"ハード分離（強いテナント隔離）"** に引き上げればOK。

---

## なぜ今はフル多層化をしないのが良いか

* Unson OSは**大量のMVPを回すスピード**が命。ここで重いマルチテナント（RBAC、監査、データ分離、地域制御…）を作り込むと、**初動の速度を確実に落とす**。
* ただし将来の"引き上げ"を見据えた**最小限の設計（テナンシーフック）**はないと、後で移行が地獄になる。

---

## いま入れておく"テナンシーフック"（Convex 前提の最小セット）

「作り込み」じゃなく「逃げ道」を用意する感じで。

### 1. 語彙の統一
Tenant = **Workspace/Organization** と呼ぶ（命名を固定）。

### 2. スキーマの軽量化

* 主要テーブルに **`workspace_id`（= tenant_id）** を持たせる（ユーザー、ドキュメント、ジョブ等）。
* 主要ユニーク制約は **複合キー（`workspace_id` + 列）** にする（例：スラッグ、外部ID）。

### 3. 中央ガードの一本化

* データアクセスは**必ず一段ラップ**する（例：`db.listUsers(workspaceId, query)`）。
* その中で **`assertTenant()`** を通し、**クエリに必ず `workspace_id` を差す**。
* 直にテーブルへ触るコードは禁止（ESLint で守る）。

### 4. セッションにテナントを載せる

* Auth後のサーバセッションに **`workspace_id`** を必ず含め、Server Actions / Convex 関数の**第一引数で受ける**。

### 5. ルーティング規約

* どちらかを統一：**サブドメイン方式**（`{org}.app.com`） or **パス方式**（`/org/{slug}/...`）。
* どっちでもいいけど**一度決めたら全サービス共通**に。

### 6. テストで"漏れ"検出

* E2Eで**異テナントのデータが見えない**ことを必ず検証（最低1本のリークテスト）。
* Fakerで2テナント分のダミーデータを流し、クロスアクセスを落とす。

### 7. 監査のひな形

* 監査ログ（軽量でOK）に **`workspace_id` / `actor_id` / `action`** だけ記録する関数を用意（中身は後で強化）。

### 8. 請求の前提

* Stripe 顧客オブジェクトは**原則 Workspace 単位**で作る（個人課金なら Workspace=個人で問題なし）。

> **ポイント：**"今すぐ複雑なRBACやデータ領域分離は作らない"。 でも**`workspace_id` を入れておくかどうかで将来の移行難度が天と地**。

---

## どのタイミングで"本気のマルチテナント"に引き上げる？

下のスイッチ条件の**どれかに当たったら**、そのサービスは **Cloudflare でハード分離**を検討。

* **チーム/企業ユースが主**（席課金、SSO、監査が要る）
* **規制/法務要件**（データ削除・保持義務、データ越境NG）
* **顧客単価が高い**（SLA/隔離を対価として求められる）
* **急な伸び**で他サービスと**リソース干渉を避けたい**

---

## Cloudflare での"ハード分離"の型（共通基盤づくり）

Cloudflare期は**インフラ境界での隔離**を選べるのが強み。サービスの性格で使い分け。

### 型A：1サービス=1データベース（中は`workspace_id`で軽量MT）
小規模B2C/ソロ向け。運用が一番シンプル。

### 型B：1テナント=1データベース（強隔離）
企業・規制対応が必要なサービス。**テナントレジストリ**（KV等）で
`org -> DBハンドル` を引き、**リクエスト毎に接続先を切替**。
監査/バックアップ/サンセットも**テナント単位**で完結。

### 型C：ハイブリッド
まず型Aで走り、**大口テナントだけ型B**へ"昇格"。

共通基盤としては、**SSO/認可、課金、テレメトリ、監査、フィーチャーフラグ**を**横断モジュール**に切り出して、どのサービスにも同じ形で刺さるようにしておくのがコツ（プラットフォーム非依存の薄いAPIにしておく）。

---

## 移行を痛くしないための"青写真"

1. **データモデルの互換を維持**：Convex側の全テーブルに `workspace_id` が載っていればマッピングが容易。
2. **移行器（Exporter/Importer）**：Convex →（一時ファイル or 直パイプ）→ 新DB。
3. **ディレクトリ（テナントレジストリ）**を先に用意：`domain|slug -> workspace_id -> DB接続先`。
4. **短期だけデュアルライト**（新旧へ同時書込）→差分検証→**本切替**。
5. **ロールバック手順**を用意（旗一つで旧系に戻せるように）。

---

## 実装ロードマップ

### Phase 1: Tenant-Light実装（現在〜1ヶ月）
- [ ] 既存スキーマへの`workspace_id`追加
- [ ] データアクセス層のラッパー実装
- [ ] テナント検証用E2Eテスト作成
- [ ] ESLint ルールの設定

### Phase 2: 共通基盤の薄い実装（1〜3ヶ月）
- [ ] 認証・認可の基礎実装
- [ ] 課金システムとの統合
- [ ] 軽量監査ログ実装
- [ ] テレメトリ基盤

### Phase 3: Cloudflare移行準備（3〜6ヶ月）
- [ ] テナントレジストリ設計
- [ ] データ移行ツール開発
- [ ] デュアルライト機構実装
- [ ] 移行手順書作成

---

## まとめ

* **今は**：Vercel + Convex で**"Tenant‑Light"**（上の8点だけ入れる）。
* **伸びたら**：そのサービスだけ Cloudflare で**"ハード分離"**に昇格（型B or C）。
* **全体として**：SSO/課金/監査/実験の**共通基盤は早めに薄く作る**（プラットフォームに強依存しない形）。

この戦略により、開発スピードを維持しつつ、将来の成長に向けた柔軟性を確保します。