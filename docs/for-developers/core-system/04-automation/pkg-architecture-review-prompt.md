# PKG高度DAGアーキテクチャ レビュー依頼プロンプト

## レビュー対象ドキュメント
`docs/for-developers/core-system/04-automation/pkg-system-advanced-dag.md`

## レビューをお願いしたい背景

UnsonOSのPKGシステムは、100-200個のマイクロSaaSを自動管理するための中核システムです。
今回、以下の2つの高度な概念を統合した新しいアーキテクチャを設計しました：

1. **4段階DAGアーキテクチャ**（FX取引システムから着想）
2. **厳密な階層参照ルール**（関数型プログラミングの原則）

## レビューの観点

### 1. アーキテクチャの妥当性
- [ ] DAG構造は数学的に正しいか？
- [ ] 階層参照ルール（階層N→階層N-1以下のみ）は合理的か？
- [ ] 素材DAGと判定DAGの分離は適切か？
- [ ] 財務DAGの位置づけは妥当か？

### 2. 実装可能性
- [ ] 提案されたTypeScriptコードは実装可能か？
- [ ] パフォーマンス目標（全体50ms以内）は現実的か？
- [ ] 並列実行戦略は効果的か？
- [ ] 動的階層管理は実用的か？

### 3. 既存システムとの整合性
- [ ] 現在の3層構造（Symbol→Guard→PKG）との互換性は？
- [ ] 既存のPKG命名規則との整合性は？
- [ ] 移行パスは明確か？

### 4. スケーラビリティ
- [ ] 100-200個のSaaSで問題なく動作するか？
- [ ] 階層が深くなった場合（10層以上）の影響は？
- [ ] 各階層に数百ノードがある場合の処理は？

## 特に確認してほしい箇所

### PKG ID体系（セクション2）
```
991^N-XXX
```
- この体系で無限階層を表現できているか？
- 連番999個の制限は適切か？

### 階層参照バリデーション（セクション6.1）
```typescript
if (depLayer >= nodeLayer) {
  throw new Error(...);
}
```
- このチェックロジックは十分か？
- エッジケースはないか？

### 並列実行エンジン（セクション7.1）
```typescript
// 同一階層内のノードを並列実行
const layerResults = await Promise.all(
  nodes.map(node => this.executeNode(node, results))
);
```
- この並列化アプローチは適切か？
- デッドロックのリスクはないか？

## 期待する成果物

1. **技術的レビューコメント**
   - アーキテクチャの問題点
   - 改善提案
   - リスクの指摘

2. **実装推奨事項**
   - 優先的に実装すべき部分
   - 段階的移行の提案
   - テスト戦略

3. **質問事項への回答**
   - 不明確な点の明確化
   - 追加すべき仕様

## レビュー用質問テンプレート

```markdown
## アーキテクチャレビュー結果

### 1. 全体評価
- 強み：
- 懸念点：
- 改善提案：

### 2. 技術的詳細
- DAG構造の妥当性：
- 階層ルールの評価：
- パフォーマンス見積もり：

### 3. 実装推奨
- 最初に実装すべき部分：
- リスクの高い部分：
- テスト戦略：

### 4. 質問・不明点
- 
```

---

## 参考情報

### 現在のシステム構成
- 3層アーキテクチャ（Symbol→Guard→PKG）
- 300-500個のSymbol
- 2h/24h/48hのサイクル実行
- 20並列バッチ処理

### 主要な制約
- 実行時間：50ms以内（目標）
- メモリ使用量：1GB以内
- 同時処理SaaS数：20

### 関連ドキュメント
- `pkg-system.md`：現在のPKGシステム仕様
- `api.md`：API設計書
- `testing-guidelines.md`：テストガイドライン

---

作成日：2025年1月
レビュー期限：できるだけ早く
連絡先：GitHubのPRコメント欄