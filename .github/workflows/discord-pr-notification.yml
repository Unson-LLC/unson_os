name: Discord PR Notification

on:
  pull_request:
    types: [opened, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Generate PR Summary with AI
      id: summary
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        # PRæƒ…å ±ã‚’å–å¾—
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_BODY="${{ github.event.pull_request.body }}"
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        PR_STATE="${{ github.event.pull_request.state }}"
        PR_MERGED="${{ github.event.pull_request.merged }}"
        
        # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¦ç´„ç”Ÿæˆ
        cat > generate_summary.py << 'EOF'
        import os
        import json
        import sys
        from anthropic import Anthropic
        
        pr_title = os.environ.get('PR_TITLE', '')
        pr_body = os.environ.get('PR_BODY', '')
        pr_merged = os.environ.get('PR_MERGED', 'false')
        event_name = os.environ.get('GITHUB_EVENT_NAME', '')
        
        # ç°¡æ½”ãªè¦ç´„ã‚’ç”Ÿæˆï¼ˆAIãªã—ã§ã‚‚å‹•ä½œï¼‰
        if pr_merged == 'true':
            summary = f"âœ… PR ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸï¼\n**{pr_title}**"
        elif event_name == 'pull_request' and os.environ.get('PR_STATE') == 'open':
            summary = f"ğŸ”„ æ–°ã—ã„PRãŒä½œæˆã•ã‚Œã¾ã—ãŸ\n**{pr_title}**"
        else:
            summary = pr_title
        
        # PRæœ¬æ–‡ã‹ã‚‰ä¸»è¦ãªå¤‰æ›´ç‚¹ã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        if pr_body:
            lines = pr_body.split('\n')
            key_points = []
            for line in lines:
                if line.startswith('- ') or line.startswith('* '):
                    key_points.append(line)
                    if len(key_points) >= 3:
                        break
            
            if key_points:
                summary += "\n\n**ä¸»ãªå¤‰æ›´:**\n" + '\n'.join(key_points[:3])
        
        print(summary)
        EOF
        
        export PR_TITLE PR_BODY PR_URL PR_AUTHOR PR_STATE PR_MERGED GITHUB_EVENT_NAME
        SUMMARY=$(python generate_summary.py)
        echo "SUMMARY<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Send PR Opened Notification
      if: github.event.action == 'opened'
      uses: tsickert/discord-webhook@v5.3.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        username: UnsonOS Bot
        avatar-url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
        embed-title: "ğŸ”„ æ–°ã—ã„PRãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
        embed-url: "${{ github.event.pull_request.html_url }}"
        embed-description: |
          ${{ steps.summary.outputs.SUMMARY }}
          
          **ä½œæˆè€…:** ${{ github.event.pull_request.user.login }}
          **ãƒ–ãƒ©ãƒ³ãƒ:** `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`
          
          [PRã‚’ç¢ºèªã™ã‚‹](${{ github.event.pull_request.html_url }})
        embed-color: 3447003
        
    - name: Send PR Merged Notification
      if: github.event.pull_request.merged == true
      uses: tsickert/discord-webhook@v5.3.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        username: UnsonOS Bot
        avatar-url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
        embed-title: "âœ… PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸï¼"
        embed-url: "${{ github.event.pull_request.html_url }}"
        embed-description: |
          ${{ steps.summary.outputs.SUMMARY }}
          
          **ãƒãƒ¼ã‚¸è€…:** ${{ github.event.pull_request.merged_by.login }}
          **ä½œæˆè€…:** ${{ github.event.pull_request.user.login }}
          
          [ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’è¦‹ã‚‹](${{ github.event.pull_request.html_url }}/commits)
        embed-color: 2067276