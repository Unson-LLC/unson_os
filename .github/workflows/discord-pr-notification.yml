name: Discord PR Notification

on:
  pull_request:
    types: [opened, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Generate PR Summary
      id: summary
      run: |
        # PR情報を取得
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_MERGED="${{ github.event.pull_request.merged }}"
        
        # 簡潔な要約を生成
        if [ "$PR_MERGED" = "true" ]; then
            SUMMARY="✅ PRがマージされました！"
        else
            SUMMARY="🔄 新しいPRが作成されました"
        fi
        
        echo "SUMMARY=$SUMMARY" >> $GITHUB_OUTPUT
        
    - name: Send PR Opened Notification
      if: github.event.action == 'opened'
      uses: tsickert/discord-webhook@v5.3.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        username: UnsonOS Bot
        avatar-url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
        embed-title: "🔄 新しいPRが作成されました"
        embed-url: "${{ github.event.pull_request.html_url }}"
        embed-description: |
          **${{ github.event.pull_request.title }}**
          
          **作成者:** ${{ github.event.pull_request.user.login }}
          **ブランチ:** `${{ github.event.pull_request.head.ref }}` → `${{ github.event.pull_request.base.ref }}`
          
          [PRを確認する](${{ github.event.pull_request.html_url }})
        embed-color: 3447003
        
    - name: Send PR Merged Notification
      if: github.event.pull_request.merged == true
      uses: tsickert/discord-webhook@v5.3.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        username: UnsonOS Bot
        avatar-url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
        embed-title: "✅ PRがマージされました！"
        embed-url: "${{ github.event.pull_request.html_url }}"
        embed-description: |
          **${{ github.event.pull_request.title }}**
          
          **マージ者:** ${{ github.event.pull_request.merged_by.login }}
          **作成者:** ${{ github.event.pull_request.user.login }}
          
          [コミット履歴を見る](${{ github.event.pull_request.html_url }}/commits)
        embed-color: 2067276